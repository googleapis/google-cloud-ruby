---
layout: yard_main
title: "Class: Google::Apis::Core::DownloadCommand - Google"
css: 
  - /docs/css/style.css
  - /docs/css/common.css
  - /css/docs.css
js: 
  - /docs/js/app.js
  - /js/docs.js
---
<script type="text/javascript" charset="utf-8">
  pathId = "Google::Apis::Core::DownloadCommand";
  relpath = '../../../';
</script>


<div class="nav_wrap">
  <iframe id="nav" src="../../../class_list.html?1"></iframe>
  <div id="resizer"></div>
</div>

<div id="main" tabindex="-1">
  <div id="header">
    <div id="menu">
  
    <a href="../../../_index.html">Index (D)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Apis.html" title="Google::Apis (module)">Apis</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Core.html" title="Google::Apis::Core (module)">Core</a></span></span>
     &raquo; 
    <span class="title">DownloadCommand</span>
  
</div>

    <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
    <div class="clear"></div>
  </div>

  <div id="content"><h1>Class: Google::Apis::Core::DownloadCommand
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">ApiCommand</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ApiCommand</li>
          
            <li class="next">Google::Apis::Core::DownloadCommand</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/google/cloud/storage/service.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Streaming/resumable media download support</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_once_with_response-instance_method" title="#execute_once_with_response (instance method)">#<strong>execute_once_with_response</strong>(client, &amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a two-element array containing:   * The <code>result</code> that is the usual return type of #execute_once.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_with_response-instance_method" title="#execute_with_response (instance method)">#<strong>execute_with_response</strong>(client)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a two-element array containing:   * The <code>result</code> that is the usual return type of #execute.</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="execute_once_with_response-instance_method">
  
    #<strong>execute_once_with_response</strong>(client, &amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a two-element array containing:</p>

<ul>
<li>The <code>result</code> that is the usual return type of #execute_once.</li>
<li>The <code>http_resp</code>.</li>
</ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/storage/service.rb', line 661</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_once_with_response'>execute_once_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request_header'>request_header</span> <span class='op'>=</span> <span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_apply_request_options'>apply_request_options</span><span class='lparen'>(</span><span class='id identifier rubyid_request_header'>request_header</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='kw'>if</span> <span class='ivar'>@offset</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_sprintf'>sprintf</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Resuming download from offset %d</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@offset</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_request_header'>request_header</span><span class='lbracket'>[</span><span class='const'>RANGE_HEADER</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sprintf'>sprintf</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bytes=%d-</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@offset</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_http_res'>http_res</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
             <span class='label'>query:</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span>
             <span class='label'>header:</span> <span class='id identifier rubyid_request_header'>request_header</span><span class='comma'>,</span>
             <span class='label'>follow_redirect:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='op'>|</span>
    <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_http_header'>http_header</span><span class='period'>.</span><span class='id identifier rubyid_status_code'>status_code</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='const'>OK_STATUS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>||=</span> <span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>206</span> <span class='op'>?</span> <span class='ivar'>@offset</span> <span class='op'>:</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_download_offset'>download_offset</span>  <span class='op'>+=</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>==</span> <span class='ivar'>@offset</span>
      <span class='id identifier rubyid_next_chunk'>next_chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span>
    <span class='kw'>else</span>
      <span class='comment'># Oh no! Requested a chunk, but received the entire content
</span>      <span class='id identifier rubyid_chunk_index'>chunk_index</span> <span class='op'>=</span> <span class='ivar'>@offset</span> <span class='op'>-</span> <span class='lparen'>(</span><span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_next_chunk'>next_chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_byteslice'>byteslice</span><span class='lparen'>(</span><span class='id identifier rubyid_chunk_index'>chunk_index</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
    <span class='comment'># logger.debug { sprintf(&#39;Writing chunk (%d bytes, %d total)&#39;, chunk.length, bytes_read) }
</span>    <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='rparen'>)</span>

    <span class='ivar'>@offset</span> <span class='op'>+=</span> <span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>
  <span class='kw'>end</span>

  <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_flush'>flush</span>

  <span class='kw'>if</span> <span class='ivar'>@close_io_on_finish</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='ivar'>@download_io</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_check_status'>check_status</span><span class='lparen'>(</span><span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_success'>success</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_flush'>flush</span>
  <span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>rethrow:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="execute_with_response-instance_method">
  
    #<strong>execute_with_response</strong>(client)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a two-element array containing:</p>

<ul>
<li>The <code>result</code> that is the usual return type of #execute.</li>
<li>The <code>http_resp</code> from #execute_once.</li>
</ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/storage/service.rb', line 626</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_with_response'>execute_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_prepare!'>prepare!</span>
  <span class='kw'>begin</span>
    <span class='const'>Retriable</span><span class='period'>.</span><span class='id identifier rubyid_retriable'>retriable</span> <span class='label'>tries:</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_retries'>retries</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span>
                        <span class='label'>base_interval:</span> <span class='int'>1</span><span class='comma'>,</span>
                        <span class='label'>multiplier:</span> <span class='int'>2</span><span class='comma'>,</span>
                        <span class='label'>on:</span> <span class='const'>RETRIABLE_ERRORS</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_try'>try</span><span class='op'>|</span>
      <span class='comment'># This 2nd level retriable only catches auth errors, and supports 1 retry, which allows
</span>      <span class='comment'># auth to be re-attempted without having to retry all sorts of other failures like
</span>      <span class='comment'># NotFound, etc
</span>      <span class='id identifier rubyid_auth_tries'>auth_tries</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_try'>try</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_authorization_refreshable?'>authorization_refreshable?</span> <span class='op'>?</span> <span class='int'>2</span> <span class='op'>:</span> <span class='int'>1</span><span class='rparen'>)</span>
      <span class='const'>Retriable</span><span class='period'>.</span><span class='id identifier rubyid_retriable'>retriable</span> <span class='label'>tries:</span> <span class='id identifier rubyid_auth_tries'>auth_tries</span><span class='comma'>,</span>
                          <span class='label'>on:</span> <span class='lbracket'>[</span><span class='const'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Apis.html" title="Google::Apis (module)">Apis</a></span></span><span class='op'>::</span><span class='const'>AuthorizationError</span><span class='comma'>,</span> <span class='const'>Signet</span><span class='op'>::</span><span class='const'>AuthorizationError</span><span class='rbracket'>]</span><span class='comma'>,</span>
                          <span class='label'>on_retry:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='op'>*</span><span class='op'>|</span> <span class='id identifier rubyid_refresh_authorization'>refresh_authorization</span> <span class='rbrace'>}</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_execute_once_with_response'>execute_once_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_result'>result</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
            <span class='kw'>yield</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='kw'>nil</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
      <span class='kw'>yield</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_release!'>release!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

  <div id="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby" title="Google Cloud on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> GitHub
      </a>
    </li>
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/issues" title="Google Cloud issues on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> Issues
      </a>
    </li>
    <li>
      <a href="http://stackoverflow.com/questions/tagged/google-cloud-ruby" title="Google Cloud on StackOverflow">
      <img src="/google-cloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon"> StackOverflow
    </a>
    </li>
    <li>
      <a href="http://rubygems.org/gems/google-cloud" title="Google Cloud on RubyGems">
        <img src="/google-cloud-ruby/img/icon-link-package-manager.svg" alt="RubyGems icon"> RubyGems
      </a>
    </li>
  </ul>

  <p>
    Documentation generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>.
  </p>
</div>

</div>














<!--
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Google::Apis::Core::DownloadCommand
  
    &mdash; Google
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Google::Apis::Core::DownloadCommand";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div id="google-cloud-header"></div>

    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../_index.html">Index (D)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Apis.html" title="Google::Apis (module)">Apis</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Core.html" title="Google::Apis::Core (module)">Core</a></span></span>
     &raquo; 
    <span class="title">DownloadCommand</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Google::Apis::Core::DownloadCommand
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">ApiCommand</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ApiCommand</li>
          
            <li class="next">Google::Apis::Core::DownloadCommand</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/google/cloud/storage/service.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Streaming/resumable media download support</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_once_with_response-instance_method" title="#execute_once_with_response (instance method)">#<strong>execute_once_with_response</strong>(client, &amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a two-element array containing:   * The <code>result</code> that is the usual return type of #execute_once.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_with_response-instance_method" title="#execute_with_response (instance method)">#<strong>execute_with_response</strong>(client)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a two-element array containing:   * The <code>result</code> that is the usual return type of #execute.</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="execute_once_with_response-instance_method">
  
    #<strong>execute_once_with_response</strong>(client, &amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a two-element array containing:</p>

<ul>
<li>The <code>result</code> that is the usual return type of #execute_once.</li>
<li>The <code>http_resp</code>.</li>
</ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/storage/service.rb', line 661</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_once_with_response'>execute_once_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request_header'>request_header</span> <span class='op'>=</span> <span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_apply_request_options'>apply_request_options</span><span class='lparen'>(</span><span class='id identifier rubyid_request_header'>request_header</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='kw'>if</span> <span class='ivar'>@offset</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_sprintf'>sprintf</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Resuming download from offset %d</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@offset</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_request_header'>request_header</span><span class='lbracket'>[</span><span class='const'>RANGE_HEADER</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sprintf'>sprintf</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bytes=%d-</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@offset</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_http_res'>http_res</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
             <span class='label'>query:</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span>
             <span class='label'>header:</span> <span class='id identifier rubyid_request_header'>request_header</span><span class='comma'>,</span>
             <span class='label'>follow_redirect:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='op'>|</span>
    <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_http_header'>http_header</span><span class='period'>.</span><span class='id identifier rubyid_status_code'>status_code</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='const'>OK_STATUS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>||=</span> <span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>206</span> <span class='op'>?</span> <span class='ivar'>@offset</span> <span class='op'>:</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_download_offset'>download_offset</span>  <span class='op'>+=</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span> <span class='op'>==</span> <span class='ivar'>@offset</span>
      <span class='id identifier rubyid_next_chunk'>next_chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span>
    <span class='kw'>else</span>
      <span class='comment'># Oh no! Requested a chunk, but received the entire content
</span>      <span class='id identifier rubyid_chunk_index'>chunk_index</span> <span class='op'>=</span> <span class='ivar'>@offset</span> <span class='op'>-</span> <span class='lparen'>(</span><span class='id identifier rubyid_download_offset'>download_offset</span> <span class='op'>-</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_next_chunk'>next_chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_byteslice'>byteslice</span><span class='lparen'>(</span><span class='id identifier rubyid_chunk_index'>chunk_index</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
    <span class='comment'># logger.debug { sprintf(&#39;Writing chunk (%d bytes, %d total)&#39;, chunk.length, bytes_read) }
</span>    <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='rparen'>)</span>

    <span class='ivar'>@offset</span> <span class='op'>+=</span> <span class='id identifier rubyid_next_chunk'>next_chunk</span><span class='period'>.</span><span class='id identifier rubyid_bytesize'>bytesize</span>
  <span class='kw'>end</span>

  <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_flush'>flush</span>

  <span class='kw'>if</span> <span class='ivar'>@close_io_on_finish</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='ivar'>@download_io</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_check_status'>check_status</span><span class='lparen'>(</span><span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_success'>success</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_http_res'>http_res</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='ivar'>@download_io</span><span class='period'>.</span><span class='id identifier rubyid_flush'>flush</span>
  <span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>rethrow:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="execute_with_response-instance_method">
  
    #<strong>execute_with_response</strong>(client)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a two-element array containing:</p>

<ul>
<li>The <code>result</code> that is the usual return type of #execute.</li>
<li>The <code>http_resp</code> from #execute_once.</li>
</ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/storage/service.rb', line 626</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_with_response'>execute_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_prepare!'>prepare!</span>
  <span class='kw'>begin</span>
    <span class='const'>Retriable</span><span class='period'>.</span><span class='id identifier rubyid_retriable'>retriable</span> <span class='label'>tries:</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_retries'>retries</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span>
                        <span class='label'>base_interval:</span> <span class='int'>1</span><span class='comma'>,</span>
                        <span class='label'>multiplier:</span> <span class='int'>2</span><span class='comma'>,</span>
                        <span class='label'>on:</span> <span class='const'>RETRIABLE_ERRORS</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_try'>try</span><span class='op'>|</span>
      <span class='comment'># This 2nd level retriable only catches auth errors, and supports 1 retry, which allows
</span>      <span class='comment'># auth to be re-attempted without having to retry all sorts of other failures like
</span>      <span class='comment'># NotFound, etc
</span>      <span class='id identifier rubyid_auth_tries'>auth_tries</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_try'>try</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_authorization_refreshable?'>authorization_refreshable?</span> <span class='op'>?</span> <span class='int'>2</span> <span class='op'>:</span> <span class='int'>1</span><span class='rparen'>)</span>
      <span class='const'>Retriable</span><span class='period'>.</span><span class='id identifier rubyid_retriable'>retriable</span> <span class='label'>tries:</span> <span class='id identifier rubyid_auth_tries'>auth_tries</span><span class='comma'>,</span>
                          <span class='label'>on:</span> <span class='lbracket'>[</span><span class='const'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Apis.html" title="Google::Apis (module)">Apis</a></span></span><span class='op'>::</span><span class='const'>AuthorizationError</span><span class='comma'>,</span> <span class='const'>Signet</span><span class='op'>::</span><span class='const'>AuthorizationError</span><span class='rbracket'>]</span><span class='comma'>,</span>
                          <span class='label'>on_retry:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='op'>*</span><span class='op'>|</span> <span class='id identifier rubyid_refresh_authorization'>refresh_authorization</span> <span class='rbrace'>}</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_execute_once_with_response'>execute_once_with_response</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_result'>result</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
            <span class='kw'>yield</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='kw'>nil</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
      <span class='kw'>yield</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_release!'>release!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby" title="Google Cloud on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> GitHub
      </a>
    </li>
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/issues" title="Google Cloud issues on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> Issues
      </a>
    </li>
    <li>
      <a href="http://stackoverflow.com/questions/tagged/google-cloud-ruby" title="Google Cloud on StackOverflow">
      <img src="/google-cloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon"> StackOverflow
    </a>
    </li>
    <li>
      <a href="http://rubygems.org/gems/google-cloud" title="Google Cloud on RubyGems">
        <img src="/google-cloud-ruby/img/icon-link-package-manager.svg" alt="RubyGems icon"> RubyGems
      </a>
    </li>
  </ul>

  <p>
    Documentation generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>.
  </p>
</div>

    </div>
  </body>
</html>
-->
