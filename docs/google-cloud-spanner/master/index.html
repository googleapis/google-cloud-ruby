---
layout: yard_main
title: "File: OVERVIEW - Google"
css: 
  - /docs/css/style.css
  - /docs/css/common.css
  - /css/yard-main.css
js: 
  - /docs/js/app.js
  - /js/yard-main.js
---
<script type="text/javascript" charset="utf-8">
  pathId = "OVERVIEW";
  relpath = '';
</script>


<div class="nav_wrap">
  <iframe id="nav" src="class_list.html?1"></iframe>
  <div id="resizer"></div>
</div>

<div id="main" tabindex="-1">
  <div id="header">
    <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: OVERVIEW</span>
  
</div>

    <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
    <div class="clear"></div>
  </div>

  <div id="content"><div id='filecontents'><h1>Cloud Spanner</h1>

<p>Cloud Spanner is a fully managed, mission-critical, relational database service
that offers transactional consistency at global scale, schemas, SQL (ANSI 2011
with extensions), and automatic, synchronous replication for high availability.</p>

<p>For more information about Cloud Spanner, read the <a href="https://cloud.google.com/spanner/docs/">Cloud Spanner
Documentation</a>.</p>

<p>The goal of google-cloud is to provide an API that is comfortable to Rubyists.
Your authentication credentials are detected automatically in Google Cloud
Platform environments such as Google Compute Engine, Google App Engine and
Google Kubernetes Engine. In other environments you can configure authentication
easily, either directly in your code or via environment variables. Read more
about the options for connecting in the <a href="file.AUTHENTICATION.html" title="Authentication Guide">Authentication Guide</a>.</p>

<h2>Creating instances</h2>

<p>When you first use Cloud Spanner, you must create an instance, which is an
allocation of resources that are used by Cloud Spanner databases. When you
create an instance, you choose where your data is stored and how many nodes are
used for your data. (For more information, see <a href="https://googlecloudplatform.github.io/google-cloud-ruby/docs/stackdriver/latest/file.INSTRUMENTATION_CONFIGURATION">Configuration
Guide</a>).</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Project.html#create_instance-instance_method" title="Google::Cloud::Spanner::Project#create_instance (method)">Project#create_instance</a></span> to
create an instance:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_create_instance'>create_instance</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                              <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>My Instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                              <span class='label'>config:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>regional-us-central1</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                              <span class='label'>nodes:</span> <span class='int'>5</span><span class='comma'>,</span>
                              <span class='label'>labels:</span> <span class='lbrace'>{</span> <span class='label'>production:</span> <span class='symbol'>:env</span> <span class='rbrace'>}</span>

<span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_done?'>done?</span> <span class='comment'>#=&gt; false
</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_reload!'>reload!</span> <span class='comment'># API call
</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_done?'>done?</span> <span class='comment'>#=&gt; true
</span>
<span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_error?'>error?</span>
  <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span>
<span class='kw'>else</span>
  <span class='id identifier rubyid_instance'>instance</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
<span class='kw'>end</span>
</code></pre>

<h2>Creating databases</h2>

<p>Now that you have created an instance, you can create a database. Cloud
Spanner databases hold the tables and indexes that allow you to read and
write data. You may create multiple databases in an instance.</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Project.html#create_database-instance_method" title="Google::Cloud::Spanner::Project#create_database (method)">Project#create_database</a></span>
(or <span class='object_link'><a href="Google/Cloud/Spanner/Instance.html#create_database-instance_method" title="Google::Cloud::Spanner::Instance#create_database (method)">Instance#create_database</a></span>)
to create a database:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_create_database'>create_database</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_done?'>done?</span> <span class='comment'>#=&gt; false
</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_reload!'>reload!</span> <span class='comment'># API call
</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_done?'>done?</span> <span class='comment'>#=&gt; true
</span>
<span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_error?'>error?</span>
  <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span>
<span class='kw'>else</span>
  <span class='id identifier rubyid_database'>database</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_database'>database</span>
<span class='kw'>end</span>
</code></pre>

<h2>Updating database schemas</h2>

<p>Cloud Spanner supports schema updates to a database while the database
continues to serve traffic. Schema updates do not require taking the
database offline and they do not lock entire tables or columns; you can
continue writing data to the database during the schema update.</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Database.html#update-instance_method" title="Google::Cloud::Spanner::Database#update (method)">Database#update</a></span> to execute one or
more statements in Cloud Spanner&#39;s Data Definition Language (DDL):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_database'>database</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_database'>database</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_add_users_table_sql'>add_users_table_sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%q(</span><span class='tstring_content'>
  CREATE TABLE users (
    id INT64 NOT NULL,
    username STRING(25) NOT NULL,
    name STRING(45) NOT NULL,
    email STRING(128),
  ) PRIMARY KEY(id)
</span><span class='tstring_end'>)</span></span>

<span class='id identifier rubyid_database'>database</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span> <span class='label'>statements:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_add_users_table_sql'>add_users_table_sql</span><span class='rbracket'>]</span>
</code></pre>

<h2>Creating clients</h2>

<p>In order to read and/or write data, you must create a database client. You can
think of a client as a database connection: All of your interactions with Cloud
Spanner data must go through a client. Typically you create a client when your
application starts up, then you re-use that client to read, write, and execute
transactions.</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Project.html#client-instance_method" title="Google::Cloud::Spanner::Project#client (method)">Project#client</a></span> to create a client:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> <span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT 1</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_results'>results</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_row'>row</span>
<span class='kw'>end</span>
</code></pre>

<h2>Writing data</h2>

<p>You write data using your client object. The client object supports various
mutation operations, as well as combinations of inserts, updates, deletes, etc.,
that can be applied atomically to different rows and/or tables in a database.</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Client.html#commit-instance_method" title="Google::Cloud::Spanner::Client#commit (method)">Client#commit</a></span> to execute various
mutations atomically at a single logical point in time. All changes are
accumulated in memory until the block completes. Unlike
<span class='object_link'><a href="Google/Cloud/Spanner/Client.html#transaction-instance_method" title="Google::Cloud::Spanner::Client#transaction (method)">Client#transaction</a></span>, which can also
perform reads, this operation accepts only mutations and makes a single API
request.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_commit'>commit</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
  <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>username:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>charlie94</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Charlie</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>username:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>harvey00</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Harvey</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<h2>Querying data using SQL</h2>

<p>Cloud Spanner supports a native SQL interface for reading data that is available
through <span class='object_link'><a href="Google/Cloud/Spanner/Client.html#execute-instance_method" title="Google::Cloud::Spanner::Client#execute (method)">Client#execute</a></span>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> <span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM users</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_results'>results</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h2>Reading data using the read method</h2>

<p>In addition to Cloud Spanner&#39;s SQL interface, Cloud Spanner also supports a read
interface. Use the <span class='object_link'><a href="Google/Cloud/Spanner/Client.html#read-instance_method" title="Google::Cloud::Spanner::Client#read (method)">Client#read</a></span> method to
read rows from the database, and use its <code>keys</code> option to pass unique
identifiers as both lists and ranges:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> <span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='symbol'>:id</span><span class='comma'>,</span> <span class='symbol'>:name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>keys:</span> <span class='int'>1</span><span class='op'>..</span><span class='int'>5</span>

<span class='id identifier rubyid_results'>results</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h2>Using read-write transactions</h2>

<p>When an operation might write data depending on values it reads, you should use
a read-write transaction to perform the reads and writes atomically.</p>

<p>Suppose that sales of <code>Albums(1, 1)</code> are lower than expected and you want to
move $200,000 from the marketing budget of <code>Albums(2, 2)</code> to it, but only if the
budget of <code>Albums(2, 2)</code> is at least $300,000.</p>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Client.html#transaction-instance_method" title="Google::Cloud::Spanner::Client#transaction (method)">Client#transaction</a></span> to execute
both reads and writes atomically at a single logical point in time. All changes
are accumulated in memory until the block completes. Transactions will be
automatically retried when possible. This operation makes separate API requests
to begin and commit the transaction.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tx'>tx</span><span class='op'>|</span>
  <span class='comment'># Read the second album budget.
</span>  <span class='id identifier rubyid_second_album_result'>second_album_result</span> <span class='op'>=</span> <span class='id identifier rubyid_tx'>tx</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Albums</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>marketing_budget</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                                <span class='label'>keys:</span> <span class='lbracket'>[</span><span class='lbracket'>[</span><span class='int'>2</span><span class='comma'>,</span> <span class='int'>2</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>1</span>
  <span class='id identifier rubyid_second_album_row'>second_album_row</span> <span class='op'>=</span> <span class='id identifier rubyid_second_album_result'>second_album_result</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_second_album_budget'>second_album_budget</span> <span class='op'>=</span> <span class='id identifier rubyid_second_album_row'>second_album_row</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

  <span class='id identifier rubyid_transfer_amount'>transfer_amount</span> <span class='op'>=</span> <span class='int'>200000</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_second_album_budget'>second_album_budget</span> <span class='op'>&lt;</span> <span class='int'>300000</span>
    <span class='comment'># Raising an exception will automatically roll back the transaction.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The second album doesn&#39;t have enough funds to transfer</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Read the first album&#39;s budget.
</span>  <span class='id identifier rubyid_first_album_result'>first_album_result</span> <span class='op'>=</span> <span class='id identifier rubyid_tx'>tx</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Albums</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>marketing_budget</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                                <span class='label'>keys:</span> <span class='lbracket'>[</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>1</span>
  <span class='id identifier rubyid_first_album_row'>first_album_row</span> <span class='op'>=</span> <span class='id identifier rubyid_first_album_result'>first_album_result</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_first_album_budget'>first_album_budget</span> <span class='op'>=</span> <span class='id identifier rubyid_first_album_row'>first_album_row</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

  <span class='comment'># Update the budgets.
</span>  <span class='id identifier rubyid_second_album_budget'>second_album_budget</span> <span class='op'>-=</span> <span class='id identifier rubyid_transfer_amount'>transfer_amount</span>
  <span class='id identifier rubyid_first_album_budget'>first_album_budget</span> <span class='op'>+=</span> <span class='id identifier rubyid_transfer_amount'>transfer_amount</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Setting first album&#39;s budget to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_first_album_budget'>first_album_budget</span><span class='embexpr_end'>}</span><span class='tstring_content'> and the </span><span class='tstring_end'>&quot;</span></span> \
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>second album&#39;s budget to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_second_album_budget'>second_album_budget</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Update the rows.
</span>  <span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='lbracket'>[</span>
    <span class='lbrace'>{</span><span class='label'>singer_id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>album_id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>marketing_budget:</span> <span class='id identifier rubyid_first_album_budget'>first_album_budget</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='lbrace'>{</span><span class='label'>singer_id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>album_id:</span> <span class='int'>2</span><span class='comma'>,</span> <span class='label'>marketing_budget:</span> <span class='id identifier rubyid_second_album_budget'>second_album_budget</span><span class='rbrace'>}</span>
  <span class='rbracket'>]</span>
  <span class='id identifier rubyid_tx'>tx</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Albums</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_rows'>rows</span>
<span class='kw'>end</span>
</code></pre>

<h2>Using read-only transactions</h2>

<p>Suppose you want to execute more than one read at the same timestamp. Read-only
transactions observe a consistent prefix of the transaction commit history, so
your application always gets consistent data. Because read-only transactions are
much faster than locking read-write transactions, we strongly recommend that you
do all of your transaction reads in read-only transactions if possible.</p>

<p>Use a <span class='object_link'><a href="Google/Cloud/Spanner/Snapshot.html" title="Google::Cloud::Spanner::Snapshot (class)">Snapshot</a></span> object to execute statements
in a read-only transaction. The snapshot object is available via a block
provided to <span class='object_link'><a href="Google/Cloud/Spanner/Client.html#snapshot-instance_method" title="Google::Cloud::Spanner::Client#snapshot (method)">Client#snapshot</a></span>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_db'>db</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_snapshot'>snapshot</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_snp'>snp</span><span class='op'>|</span>
  <span class='id identifier rubyid_results_1'>results_1</span> <span class='op'>=</span> <span class='id identifier rubyid_snp'>snp</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM users</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_results_1'>results_1</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Perform another read using the `read` method. Even if the data
</span>  <span class='comment'># is updated in-between the reads, the snapshot ensures that both
</span>  <span class='comment'># return the same data.
</span>  <span class='id identifier rubyid_results_2'>results_2</span> <span class='op'>=</span> <span class='id identifier rubyid_db'>db</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>users</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='symbol'>:id</span><span class='comma'>,</span> <span class='symbol'>:name</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_results_2'>results_2</span><span class='period'>.</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2>Deleting databases</h2>

<p>Use <span class='object_link'><a href="Google/Cloud/Spanner/Database.html#drop-instance_method" title="Google::Cloud::Spanner::Database#drop (method)">Database#drop</a></span> to delete a database:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_database'>database</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_database'>database</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-database</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_database'>database</span><span class='period'>.</span><span class='id identifier rubyid_drop'>drop</span>
</code></pre>

<h2>Deleting instances</h2>

<p>When you delete an instance, all databases within it are automatically deleted.
(If you only delete databases and not your instance, you will still incur
charges for the instance.) Use <span class='object_link'><a href="Google/Cloud/Spanner/Instance.html#delete-instance_method" title="Google::Cloud::Spanner::Instance#delete (method)">Instance#delete</a></span> to delete an instance:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/spanner</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_spanner'>spanner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Spanner.html" title="Google::Cloud::Spanner (module)">Spanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Spanner.html#new-class_method" title="Google::Cloud::Spanner.new (method)">new</a></span></span>

<span class='id identifier rubyid_instance'>instance</span> <span class='op'>=</span> <span class='id identifier rubyid_spanner'>spanner</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-instance</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span>
</code></pre>

<h2>Additional information</h2>

<p>Cloud Spanner can be configured to use gRPC&#39;s logging. To learn more, see the
<a href="file.LOGGING.html" title="Logging guide">Logging guide</a>.</p>
</div></div>

  <div id="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby" title="Google Cloud on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> GitHub
      </a>
    </li>
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/issues" title="Google Cloud issues on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> Issues
      </a>
    </li>
    <li>
      <a href="http://stackoverflow.com/questions/tagged/google-cloud-ruby" title="Google Cloud on StackOverflow">
      <img src="/google-cloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon"> StackOverflow
    </a>
    </li>
    <li>
      <a href="http://rubygems.org/gems/google-cloud" title="Google Cloud on RubyGems">
        <img src="/google-cloud-ruby/img/icon-link-package-manager.svg" alt="RubyGems icon"> RubyGems
      </a>
    </li>
  </ul>

  <p>
    Documentation generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>.
  </p>
</div>

</div>
